--=== Services ===--
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")
local Camera = Workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer

--=== Executor + Rayfield UI ===--
local Executor = identifyexecutor and identifyexecutor() or "Unknown"
local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()
local MainUI = Rayfield:CreateWindow({
	Name = "Learzy Hub | " .. Executor,
	Theme = "Amethyst",
	ToggleUIKeybind = "K",
})

--=== Tabs ===--
local tabPlayer = MainUI:CreateTab("Player", 4483362458)
local tabVisual = MainUI:CreateTab("Visual", 4483362458)

--=== Fly Feature ===--
local Fly_Enabled = false
local Fly_Speed = 60
local BodyGyro, BodyVelocity, FlyConnection
local character, humanoidRootPart
local noclippedParts = {}

local function EnableNoclip()
	table.clear(noclippedParts)
	for _, part in ipairs(character:GetDescendants()) do
		if part:IsA("BasePart") and part.CanCollide then
			noclippedParts[part] = true
			part.CanCollide = false
		end
	end
end

local function RestoreCollision()
	for part in pairs(noclippedParts) do
		if part and part:IsA("BasePart") then
			part.CanCollide = true
		end
	end
	table.clear(noclippedParts)
end

local function GetInputDirection()
	local direction = Vector3.zero
	if UserInputService:IsKeyDown(Enum.KeyCode.W) then direction += Vector3.new(0, 0, -1) end
	if UserInputService:IsKeyDown(Enum.KeyCode.S) then direction += Vector3.new(0, 0, 1) end
	if UserInputService:IsKeyDown(Enum.KeyCode.A) then direction += Vector3.new(-1, 0, 0) end
	if UserInputService:IsKeyDown(Enum.KeyCode.D) then direction += Vector3.new(1, 0, 0) end
	if UserInputService:IsKeyDown(Enum.KeyCode.Space) then direction += Vector3.new(0, 1, 0) end
	if UserInputService:IsKeyDown(Enum.KeyCode.LeftControl) then direction += Vector3.new(0, -1, 0) end
	return direction
end

local function StartFly()
	character = LocalPlayer.Character
	if not character then return end
	humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
	if not humanoidRootPart then return end

	EnableNoclip()

	BodyGyro = Instance.new("BodyGyro")
	BodyGyro.P = 9e4
	BodyGyro.MaxTorque = Vector3.new(9e9, 9e9, 9e9)
	BodyGyro.CFrame = humanoidRootPart.CFrame
	BodyGyro.Parent = humanoidRootPart

	BodyVelocity = Instance.new("BodyVelocity")
	BodyVelocity.Velocity = Vector3.zero
	BodyVelocity.MaxForce = Vector3.new(9e9, 9e9, 9e9)
	BodyVelocity.Parent = humanoidRootPart

	FlyConnection = RunService.RenderStepped:Connect(function()
		if not Fly_Enabled then return end
		local cameraCF = Camera.CFrame
		local moveVec = GetInputDirection()
		if moveVec.Magnitude == 0 then
			local hum = character:FindFirstChildOfClass("Humanoid")
			moveVec = hum and hum.MoveDirection or Vector3.zero
		end
		BodyVelocity.Velocity = moveVec.Magnitude > 0 and cameraCF:VectorToWorldSpace(moveVec).Unit * Fly_Speed or Vector3.zero
		BodyGyro.CFrame = cameraCF
		EnableNoclip()
	end)
end

local function StopFly()
	Fly_Enabled = false
	if FlyConnection then FlyConnection:Disconnect() end
	if BodyGyro then BodyGyro:Destroy() end
	if BodyVelocity then BodyVelocity:Destroy() end
	RestoreCollision()
end

tabPlayer:CreateToggle({
	Name = "Fly",
	CurrentValue = false,
	Callback = function(state)
		Fly_Enabled = state
		if state then StartFly() else StopFly() end
	end
})

tabPlayer:CreateSlider({
	Name = "Fly Speed",
	Range = {16, 200},
	Increment = 1,
	Suffix = " studs/s",
	CurrentValue = Fly_Speed,
	Callback = function(value)
		Fly_Speed = value
	end
})

--=== ESP ===--
local ESP_Drawings = {}
local ESPColor = Color3.fromRGB(255, 255, 255)
local UsernameESP = false
local BoxESP = false
local ChamsESP = false
local HealthESP = false
local DistanceESP = false

tabVisual:CreateColorPicker({
	Name = "ESP Color",
	Color = ESPColor,
	Callback = function(color) ESPColor = color end
})

tabVisual:CreateToggle({Name="Username ESP",CurrentValue=false,Callback=function(v)UsernameESP=v end})
tabVisual:CreateToggle({Name="Box ESP",CurrentValue=false,Callback=function(v)BoxESP=v end})
tabVisual:CreateToggle({Name="Chams (Highlight)",CurrentValue=false,Callback=function(v)ChamsESP=v end})
tabVisual:CreateToggle({Name="Health Bar ESP",CurrentValue=false,Callback=function(v)HealthESP=v end})
tabVisual:CreateToggle({Name="Distance ESP",CurrentValue=false,Callback=function(v)DistanceESP=v end})

local function clearESP(player)
	if ESP_Drawings[player] then
		for _,v in pairs(ESP_Drawings[player]) do
			if typeof(v) == "Instance" then v:Destroy()
			elseif typeof(v) == "table" and v.Remove then v:Remove()
			elseif typeof(v) == "function" then v() end
		end
		ESP_Drawings[player] = nil
	end
end

local function applyESP(player)
	if player == LocalPlayer then return end
	if ESP_Drawings[player] then clearESP(player) end
	ESP_Drawings[player] = {}
	player.CharacterAdded:Connect(function(char)
		task.wait(0.5)
		local hum = char:FindFirstChildOfClass("Humanoid")
		local hrp = char:FindFirstChild("HumanoidRootPart")
		if not hum or not hrp then return end
		if UsernameESP and char:FindFirstChild("Head") then
			local head = char.Head
			local gui = Instance.new("BillboardGui")
			gui.Adornee = head
			gui.AlwaysOnTop = true
			gui.Size = UDim2.new(0, 100, 0, 20)
			gui.StudsOffset = Vector3.new(0, 3, 0)
			gui.Parent = head
			local label = Instance.new("TextLabel", gui)
			label.Text = player.Name
			label.TextColor3 = ESPColor
			label.BackgroundTransparency = 1
			label.Size = UDim2.fromScale(1,1)
			label.TextScaled = true
			local stroke = Instance.new("UIStroke", label)
			stroke.Thickness = 1
			stroke.Color = Color3.new(0,0,0)
			ESP_Drawings[player].Name = gui
		end
		if ChamsESP then
			local highlight = Instance.new("Highlight")
			highlight.Adornee = char
			highlight.FillColor = ESPColor
			highlight.OutlineColor = Color3.new(0,0,0)
			highlight.FillTransparency = 0.6
			highlight.OutlineTransparency = 0.3
			highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
			highlight.Parent = Workspace
			ESP_Drawings[player].Highlight = highlight
		end
	end)
end

for _, p in ipairs(Players:GetPlayers()) do applyESP(p) end
Players.PlayerAdded:Connect(applyESP)
Players.PlayerRemoving:Connect(clearESP)

RunService.RenderStepped:Connect(function()
	for player, tbl in pairs(ESP_Drawings) do
		local char = player.Character
		local hum = char and char:FindFirstChildOfClass("Humanoid")
		local hrp = char and char:FindFirstChild("HumanoidRootPart")
		if not hrp or not hum or hum.Health <= 0 then
			if tbl.Box then tbl.Box.Visible = false end
			if tbl.Distance then tbl.Distance.Visible = false end
			if tbl.HealthBar then tbl.HealthBar.Visible = false end
			continue
		end
		local screenPos, onScreen = Camera:WorldToViewportPoint(hrp.Position)

		if BoxESP then
			if not tbl.Box then
				local box = Drawing.new("Square")
				box.Thickness = 1
				box.Filled = false
				box.Transparency = 1
				box.Color = ESPColor
				tbl.Box = box
			end
			local sizeY = 5
			local sizeX = sizeY * 0.5
			local top = hrp.Position + Vector3.new(0,sizeY/2,0)
			local bottom = hrp.Position - Vector3.new(0,sizeY/2,0)
			local p1 = Camera:WorldToViewportPoint(top)
			local p2 = Camera:WorldToViewportPoint(bottom)
			local x = (p1.X + p2.X) / 2 - sizeX*5
			local y = (p1.Y + p2.Y) / 2 - sizeY*5
			tbl.Box.Position = Vector2.new(x,y)
			tbl.Box.Size = Vector2.new(sizeX*10, sizeY*10)
			tbl.Box.Color = ESPColor
			tbl.Box.Visible = onScreen
		elseif tbl.Box then
			tbl.Box.Visible = false
		end

		if DistanceESP then
			if not tbl.Distance then
				local txt = Drawing.new("Text")
				txt.Size = 14
				txt.Center = true
				txt.Outline = true
				txt.Font = 2
				tbl.Distance = txt
			end
			local dist = math.floor((LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") and (LocalPlayer.Character.HumanoidRootPart.Position - hrp.Position).Magnitude) or 0)
			tbl.Distance.Text = dist.."m"
			tbl.Distance.Position = Vector2.new(screenPos.X, screenPos.Y - 30)
			tbl.Distance.Color = ESPColor
			tbl.Distance.Visible = onScreen
		elseif tbl.Distance then
			tbl.Distance.Visible = false
		end

		if HealthESP then
			if not tbl.HealthBar then
				local bar = Drawing.new("Square")
				bar.Filled = true
				bar.Thickness = 1
				tbl.HealthBar = bar
				local outline = Drawing.new("Square")
				outline.Filled = false
				outline.Thickness = 1
				outline.Color = Color3.new(0,0,0)
				tbl.HealthOutline = outline
			end
			local pct = math.clamp(hum.Health / hum.MaxHealth, 0, 1)
			local h = 50
			tbl.HealthBar.Size = Vector2.new(4, h * pct)
			tbl.HealthBar.Position = Vector2.new(screenPos.X - 45, screenPos.Y + 25 - h*pct)
			tbl.HealthBar.Color = Color3.fromRGB(255,0,0):Lerp(Color3.fromRGB(0,255,0), pct)
			tbl.HealthBar.Visible = onScreen
			tbl.HealthOutline.Size = Vector2.new(4, h)
			tbl.HealthOutline.Position = Vector2.new(screenPos.X - 45, screenPos.Y + 25 - h)
			tbl.HealthOutline.Visible = onScreen
		elseif tbl.HealthBar then
			tbl.HealthBar.Visible = false
			tbl.HealthOutline.Visible = false
		end
	end
end)
