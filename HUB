local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Window = Rayfield:CreateWindow({
   Name = "Learzy Hub | Tha Bronx 3",
   Icon = 0,
   LoadingTitle = "Learzy Hub",
   LoadingSubtitle = "by Learzy",
   ShowText = "Rayfield",
   Theme = "Default",
   ToggleUIKeybind = "K",

   ConfigurationSaving = {
      Enabled = true,
      FolderName = nil,
      FileName = "Big Hub"
   }
})

-- === Tab ===
local PlayerTab = Window:CreateTab("Player", 4483362458)

-- === Services ===
local players = game:GetService("Players")
local runService = game:GetService("RunService")
local camera = workspace.CurrentCamera
local localPlayer = players.LocalPlayer

-- === Settings ===
local espEnabled = false
local showBox = true
local showName = true
local showHealth = true
local showTool = true
local teamCheck = false

-- === Colors ===
local boxColor = Color3.fromRGB(255, 0, 0)
local textColor = Color3.fromRGB(255, 255, 255)
local healthBarColor = Color3.fromRGB(0, 255, 0)
local toolColor = Color3.fromRGB(0, 170, 255)

local espObjects = {}

-- === Drawing Utility ===
local function createDrawing(class, props)
    local obj = Drawing.new(class)
    for prop, val in pairs(props) do
        obj[prop] = val
    end
    return obj
end

-- === Cleanup Utility ===
local function cleanupESP()
    for player, drawings in pairs(espObjects) do
        if not player or not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then
            for _, obj in pairs(drawings) do
                if obj.Remove then obj:Remove() end
            end
            espObjects[player] = nil
        end
    end
end

-- === ESP Logic ===
runService.RenderStepped:Connect(function()
    if not espEnabled then
        for _, drawings in pairs(espObjects) do
            for _, obj in pairs(drawings) do
                obj.Visible = false
            end
        end
        return
    end

    for _, player in ipairs(players:GetPlayers()) do
        if player ~= localPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            if teamCheck and player.Team == localPlayer.Team then
                if espObjects[player] then
                    for _, obj in pairs(espObjects[player]) do
                        obj.Visible = false
                    end
                end
                continue
            end

            local char = player.Character
            local hrp = char:FindFirstChild("HumanoidRootPart")
            local head = char:FindFirstChild("Head")
            local humanoid = char:FindFirstChildOfClass("Humanoid")
            if not hrp or not head or not humanoid then continue end

            local hrpPos, onScreen = camera:WorldToViewportPoint(hrp.Position)
            if not onScreen then
                if espObjects[player] then
                    for _, obj in pairs(espObjects[player]) do
                        obj.Visible = false
                    end
                end
                continue
            end

            -- Dimensions from parts
            local boxHeight = (hrp.Position.Y - head.Position.Y + 2.5) * 14 -- adjusted
            local boxWidth = boxHeight / 2
            local boxX = hrpPos.X - boxWidth / 2
            local boxY = hrpPos.Y - boxHeight / 2

            -- Create ESP elements if missing
            if not espObjects[player] then
                espObjects[player] = {
                    Box = createDrawing("Square", {Thickness = 1, Transparency = 1, Color = boxColor, Filled = false}),
                    Name = createDrawing("Text", {Size = 13, Color = textColor, Center = true, Outline = true, Font = 2}),
                    Health = createDrawing("Line", {Thickness = 2, Transparency = 1, Color = healthBarColor}),
                    Tool = createDrawing("Text", {Size = 12, Color = toolColor, Center = true, Outline = true, Font = 2})
                }
            end

            local esp = espObjects[player]

            -- Box
            esp.Box.Position = Vector2.new(boxX, boxY)
            esp.Box.Size = Vector2.new(boxWidth, boxHeight)
            esp.Box.Visible = showBox

            -- Name
            local headPos = camera:WorldToViewportPoint(head.Position + Vector3.new(0, 1.5, 0))
            esp.Name.Text = player.Name
            esp.Name.Position = Vector2.new(headPos.X, headPos.Y)
            esp.Name.Visible = showName

            -- Health
            local hpRatio = math.clamp(humanoid.Health / humanoid.MaxHealth, 0, 1)
            local barHeight = boxHeight * hpRatio
            esp.Health.From = Vector2.new(boxX - 4, boxY + boxHeight)
            esp.Health.To = Vector2.new(boxX - 4, boxY + boxHeight - barHeight)
            esp.Health.Visible = showHealth

            -- Tool ESP
            local toolName = ""
            for _, item in ipairs(char:GetChildren()) do
                if item:IsA("Tool") then
                    toolName = item.Name
                    break
                end
            end
            local footPos = camera:WorldToViewportPoint(hrp.Position - Vector3.new(0, 3, 0))
            esp.Tool.Text = toolName
            esp.Tool.Position = Vector2.new(footPos.X, footPos.Y)
            esp.Tool.Visible = showTool and toolName ~= ""
        end
    end

    cleanupESP()
end)

-- === Rayfield Toggles ===
PlayerTab:CreateToggle({
    Name = "ESP Master Toggle",
    CurrentValue = false,
    Flag = "ESPMaster",
    Callback = function(state)
        espEnabled = state
    end
})

PlayerTab:CreateToggle({
    Name = "ESP Box",
    CurrentValue = true,
    Flag = "ESPBox",
    Callback = function(state)
        showBox = state
    end
})

PlayerTab:CreateToggle({
    Name = "ESP Username",
    CurrentValue = true,
    Flag = "ESPName",
    Callback = function(state)
        showName = state
    end
})

PlayerTab:CreateToggle({
    Name = "ESP Health Bar",
    CurrentValue = true,
    Flag = "ESPHealth",
    Callback = function(state)
        showHealth = state
    end
})

PlayerTab:CreateToggle({
    Name = "ESP Tool Under Feet",
    CurrentValue = true,
    Flag = "ESPTool",
    Callback = function(state)
        showTool = state
    end
})

PlayerTab:CreateToggle({
    Name = "Team Check",
    CurrentValue = false,
    Flag = "ESPTeam",
    Callback = function(state)
        teamCheck = state
    end
})
